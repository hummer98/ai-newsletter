name: Newsletter Delivery

on:
  # Weekly schedule: Every Monday at 0:00 UTC (9:00 JST)
  schedule:
    - cron: '0 0 * * 1'

  # Manual trigger support
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no emails sent)'
        required: false
        default: false
        type: boolean

# Required permissions for Workload Identity Federation
permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          echo "Validating required secrets and variables..."

          missing=""

          if [ -z "${{ secrets.RESEND_API_KEY }}" ]; then
            missing="${missing}RESEND_API_KEY "
          fi

          if [ -z "${{ secrets.FROM_EMAIL }}" ]; then
            missing="${missing}FROM_EMAIL "
          fi

          if [ -z "${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}" ]; then
            missing="${missing}WORKLOAD_IDENTITY_PROVIDER "
          fi

          if [ -z "${{ secrets.SERVICE_ACCOUNT_EMAIL }}" ]; then
            missing="${missing}SERVICE_ACCOUNT_EMAIL "
          fi

          if [ -z "${{ vars.CLOUDSDK_CORE_PROJECT }}" ]; then
            missing="${missing}CLOUDSDK_CORE_PROJECT "
          fi

          if [ -n "$missing" ]; then
            echo "::error::Missing required configuration: $missing"
            echo "Please configure the following in repository settings:"
            echo "  Secrets: RESEND_API_KEY, FROM_EMAIL, WORKLOAD_IDENTITY_PROVIDER, SERVICE_ACCOUNT_EMAIL"
            echo "  Variables: CLOUDSDK_CORE_PROJECT"
            exit 1
          fi

          echo "All required configuration is present."

  newsletter:
    name: Generate and Send Newsletter
    runs-on: ubuntu-latest
    needs: validate-config

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
          # Creates credentials file automatically

      - name: Run Newsletter Script
        env:
          CLOUDSDK_CORE_PROJECT: ${{ vars.CLOUDSDK_CORE_PROJECT }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          echo "Starting newsletter generation..."
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Project ID: $CLOUDSDK_CORE_PROJECT"
          echo "Dry Run: $DRY_RUN"
          echo "---"

          npm start

      - name: Log execution summary
        if: always()
        run: |
          echo "Newsletter workflow completed at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
