name: Newsletter Delivery

on:
  # Daily schedule: Every day at 0:00 UTC (9:00 JST)
  # Schedule-based filtering is handled by fetch-themes.ts
  schedule:
    - cron: '0 0 * * *'

  # Manual trigger support
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no emails sent)'
        required: false
        default: false
        type: boolean
      skip_schedule_check:
        description: 'Skip schedule check (send regardless of schedule)'
        required: false
        default: false
        type: boolean

# Required permissions for Workload Identity Federation
permissions:
  contents: read
  id-token: write

env:
  NODE_VERSION: '20'

jobs:
  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          echo "Validating required secrets and variables..."

          missing=""

          if [ -z "${{ secrets.RESEND_API_KEY }}" ]; then
            missing="${missing}RESEND_API_KEY "
          fi

          if [ -z "${{ secrets.FROM_EMAIL }}" ]; then
            missing="${missing}FROM_EMAIL "
          fi

          if [ -z "${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}" ]; then
            missing="${missing}WORKLOAD_IDENTITY_PROVIDER "
          fi

          if [ -z "${{ secrets.SERVICE_ACCOUNT_EMAIL }}" ]; then
            missing="${missing}SERVICE_ACCOUNT_EMAIL "
          fi

          # Check that at least one authentication method is set
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ] && [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            missing="${missing}CLAUDE_CODE_OAUTH_TOKEN_or_ANTHROPIC_API_KEY "
          fi

          if [ -z "${{ vars.CLOUDSDK_CORE_PROJECT }}" ]; then
            missing="${missing}CLOUDSDK_CORE_PROJECT "
          fi

          if [ -n "$missing" ]; then
            echo "::error::Missing required configuration: $missing"
            echo "Please configure the following in repository settings:"
            echo "  Secrets: RESEND_API_KEY, FROM_EMAIL, WORKLOAD_IDENTITY_PROVIDER, SERVICE_ACCOUNT_EMAIL"
            echo "  Authentication (choose one): CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY"
            echo "  Variables: CLOUDSDK_CORE_PROJECT"
            exit 1
          fi

          echo "All required configuration is present."

  newsletter:
    name: Generate and Send Newsletter
    runs-on: ubuntu-latest
    needs: validate-config

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

      - name: Fetch themes from Firestore
        id: fetch-themes
        env:
          CLOUDSDK_CORE_PROJECT: ${{ vars.CLOUDSDK_CORE_PROJECT }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          SKIP_SCHEDULE_CHECK: ${{ inputs.skip_schedule_check }}
        run: |
          echo "Fetching themes from Firestore..."

          # If skip_schedule_check is true, we'll modify behavior via env var
          if [ "$SKIP_SCHEDULE_CHECK" = "true" ]; then
            echo "Schedule check is disabled (manual override)"
          fi

          # Run fetch-themes and capture exit code
          set +e
          node dist/scripts/fetch-themes.js
          exit_code=$?
          set -e

          if [ $exit_code -eq 2 ]; then
            echo "No themes scheduled for today"
            echo "has_themes=false" >> $GITHUB_OUTPUT
          elif [ $exit_code -ne 0 ]; then
            echo "Error fetching themes"
            exit $exit_code
          else
            echo "Themes fetched:"
            cat output/themes.json
            echo "has_themes=true" >> $GITHUB_OUTPUT
          fi

      - name: Install Claude Code
        if: steps.fetch-themes.outputs.has_themes == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate newsletter with Claude Code
        if: steps.fetch-themes.outputs.has_themes == 'true'
        env:
          # Use OAuth Token if available, otherwise fall back to API Key
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || '' }}
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN || '' }}
          # Auto-approve all tool usage in CI environment
          CLAUDE_DANGEROUSLY_SKIP_PERMISSIONS: "true"
        run: |
          echo "Generating newsletter with Claude Code..."
          THEMES=$(cat output/themes.json)
          claude -p "/generate-newsletter $THEMES" > output/claude-output.txt
          echo "Newsletter generation complete"
          cat output/claude-output.txt

      - name: Build HTML newsletter
        if: steps.fetch-themes.outputs.has_themes == 'true'
        run: |
          echo "Building HTML newsletter..."
          node dist/scripts/build-html.js

      - name: Send newsletter
        if: steps.fetch-themes.outputs.has_themes == 'true' && inputs.dry_run != true
        env:
          CLOUDSDK_CORE_PROJECT: ${{ vars.CLOUDSDK_CORE_PROJECT }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
        run: |
          echo "Sending newsletter..."
          node dist/scripts/send-newsletter.js

      - name: Update delivery timestamp
        if: steps.fetch-themes.outputs.has_themes == 'true' && inputs.dry_run != true
        env:
          CLOUDSDK_CORE_PROJECT: ${{ vars.CLOUDSDK_CORE_PROJECT }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
        run: |
          echo "Updating delivery timestamp..."
          node dist/scripts/update-delivery-timestamp.js

      - name: Dry run summary
        if: steps.fetch-themes.outputs.has_themes == 'true' && inputs.dry_run == true
        run: |
          echo "=== DRY RUN MODE ==="
          echo "Newsletter was generated but not sent."
          echo ""
          echo "Generated content:"
          cat output/newsletter.json
          echo ""
          echo "HTML preview saved to output/newsletter.html"

      - name: No themes summary
        if: steps.fetch-themes.outputs.has_themes == 'false'
        run: |
          echo "=== NO THEMES SCHEDULED ==="
          echo "No themes are scheduled for delivery today."
          echo "Use 'skip_schedule_check' option to override."

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-output
          path: output/
          retention-days: 7

      - name: Log execution summary
        if: always()
        run: |
          echo "Newsletter workflow completed at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
