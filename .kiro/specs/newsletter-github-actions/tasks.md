# Implementation Plan

## Tasks

- [x] 1. プロジェクト基盤とGitHub Actionsワークフローのセットアップ
- [x] 1.1 TypeScriptプロジェクトの初期化と依存関係のインストール
  - Node.js 20.x LTS用のTypeScriptプロジェクトを作成
  - `@google-cloud/firestore`、`resend`、開発用依存関係をインストール
  - tsconfig.jsonとESLint設定を構成
  - ビルドスクリプトとランスクリプトを設定
  - _Requirements: 1.2, 1.3, 2.1_

- [x] 1.2 (P) GitHub Actionsワークフローファイルの作成
  - cronスケジュール（毎週月曜日0:00 UTC = JST 9:00）を設定
  - workflow_dispatchトリガーを追加
  - 必須シークレットとVariablesの存在確認ステップを実装
  - エラー時にワークフローを失敗させるバリデーションを追加
  - _Requirements: 5.1, 5.2, 6.1, 6.2, 6.3, 6.4_

- [x] 1.3 Workload Identity Federation認証ステップの実装
  - `google-github-actions/auth@v3`アクションを設定
  - OIDCトークンによる認証フローを構成
  - `id-token: write`権限を設定
  - 認証失敗時のエラーログ出力とワークフロー停止を実装
  - サービスアカウントキーを使用しないキーレス認証を確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 2. Firestoreコネクタの実装
- [x] 2.1 テーマ設定取得機能の実装
  - Firestoreクライアントの初期化とApplication Default Credentials使用
  - `/themes/{id}`コレクションからテーマ一覧を取得する機能
  - 各テーマドキュメントから`prompt`フィールドを抽出
  - テーマが存在しない場合のエラーハンドリング
  - 接続失敗時のエラーログ出力とワークフロー失敗処理
  - _Requirements: 1.1, 3.3, 3.4_

- [x] 2.2 (P) 購読者リスト取得機能の実装
  - `/themes/{theme-id}/mailto/`サブコレクションからの読み取り
  - 各購読者ドキュメントから`mailto`フィールドを抽出
  - 空の購読者リストの検出と警告ログ出力
  - メールアドレス形式の基本バリデーション
  - _Requirements: 2.2, 3.1, 3.2_

- [x] 3. ニュースレター生成機能の実装
- [x] 3.1 Web検索サービスの実装
  - テーマのプロンプトに基づくWeb検索クエリの構築
  - 検索API呼び出しと結果の取得
  - 検索失敗時のリトライロジック（最大3回）
  - 3回失敗後のエラーログ出力とテーマスキップ処理
  - _Requirements: 1.2, 1.5_

- [x] 3.2 コンテンツ生成サービスの実装
  - 検索結果からニュースレターコンテンツを生成
  - 件名、HTMLボディ、テキストボディの生成
  - プロンプト設定が存在しない場合のエラーハンドリング
  - 生成結果の成功/失敗ステータスを含むオブジェクト返却
  - _Requirements: 1.3, 1.4_

- [x] 3.3 全テーマ処理オーケストレーションの実装
  - 全有効テーマに対する逐次処理ループ
  - テーマごとのエラー分離（1テーマの失敗が他に影響しない）
  - 処理結果の集約と成功/失敗カウント
  - 実行サマリーのログ出力
  - _Requirements: 5.3, 5.4_

- [x] 4. メール送信機能の実装
- [x] 4.1 Resend APIクライアントの設定
  - Resend SDKの初期化とAPIキー設定
  - 送信者メールアドレス（FROM_EMAIL環境変数）の設定
  - レート制限（2リクエスト/秒）を考慮したクライアント構成
  - APIキーおよび送信者メールアドレスが設定されていない場合のエラーハンドリング
  - _Requirements: 2.1, 6.1_

- [x] 4.2 バッチメール送信機能の実装
  - 購読者リストへのバッチ送信（最大100件/リクエスト）
  - 送信先リストの全メールアドレスへの配信
  - レート制限超過時のバックオフとリトライ
  - 部分的な送信失敗の検出と失敗した送信先の報告
  - _Requirements: 2.1, 2.3, 2.4_

- [x] 4.3 (P) 送信結果とエラー処理の実装
  - 送信成功/失敗件数の集計
  - 失敗した送信先のリスト作成
  - 空の購読者リスト検出時の警告ログと正常終了
  - エラーログの記録と実行サマリーへの反映
  - _Requirements: 2.4, 2.5_

- [x] 5. 統合とエンドツーエンドフローの実装
- [x] 5.1 メインエントリーポイントの実装
  - 認証後のFirestore接続確立
  - テーマ取得、コンテンツ生成、メール送信の一連フロー結合
  - 全体的なエラーハンドリングと適切な終了コード設定
  - 実行開始・終了のログ出力
  - _Requirements: 1.1, 4.3, 5.3_

- [x] 5.2 GitHub Actionsワークフローとスクリプトの統合
  - ワークフローからTypeScriptスクリプトの実行
  - 環境変数の受け渡し（GCP_PROJECT_ID、認証情報パス）
  - シークレットの安全な参照（RESEND_API_KEY）
  - ワークフロー実行結果のサマリー出力
  - _Requirements: 5.4, 6.1, 6.2, 6.3_

- [x] 6. テストの実装
- [x] 6.1 (P) FirestoreConnectorのユニットテスト
  - モックを使用したテーマ取得のテスト
  - モックを使用した購読者リスト取得のテスト
  - 接続エラー時のエラーハンドリングテスト
  - 空データ・不正データのエッジケーステスト
  - _Requirements: 1.1, 3.1, 3.2, 3.3, 3.4_

- [x] 6.2 (P) NewsletterGeneratorのユニットテスト
  - Web検索成功時のコンテンツ生成テスト
  - Web検索失敗時のリトライとスキップテスト
  - プロンプト未設定時のエラーハンドリングテスト
  - 全テーマ処理のオーケストレーションテスト
  - _Requirements: 1.2, 1.3, 1.4, 1.5_

- [x] 6.3 (P) EmailSenderのユニットテスト
  - バッチ分割ロジックのテスト（100件超の購読者）
  - レート制限対応のバックオフテスト
  - 部分的送信失敗時のエラー報告テスト
  - 空の購読者リスト時の警告ログテスト
  - Resendサンドボックス環境での送信テスト（オプション）
  - _Requirements: 2.1, 2.3, 2.4, 2.5_

- [x] 6.4 Firestoreエミュレータを使用した統合テスト
  - エミュレータ環境のセットアップ
  - テーマと購読者データの読み取りテスト
  - 認証フローのモックテスト
  - エンドツーエンドフローの検証
  - _Requirements: 3.1, 3.2, 3.3, 4.3_
